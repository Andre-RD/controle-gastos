<div class="container">
  <h1>{{ title }}</h1>

  <!-- Seletor de Mês/Histórico -->
  <mat-card class="mb-20">
    <mat-card-header>
      <mat-card-title>Histórico Mensal</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="historico-controls">
        <mat-form-field appearance="outline" class="mes-selector">
          <mat-label>Selecionar Mês</mat-label>
          <mat-select [value]="mesSelecionado" (selectionChange)="carregarMes($event.value)">
            <mat-option *ngFor="let mes of mesesDisponiveis" [value]="mes">
              {{ formatarNomeMes(mes) }}<span *ngIf="mes === obterChaveMesAtual()"> (Atual)</span>
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="historico-buttons">
          <button mat-raised-button color="primary" (click)="exportarRelatorioMensalJSON()" [disabled]="!mesSelecionado || lancamentos.length === 0">
            <mat-icon>file_download</mat-icon>
            Exportar Mês (JSON)
          </button>
          
          <input type="file" #fileInputJSON accept=".json" (change)="importarRelatorioMensalJSON($event)" style="display: none;">
          <button mat-raised-button color="accent" type="button" (click)="fileInputJSON.click()">
            <mat-icon>file_upload</mat-icon>
            Importar (JSON)
          </button>
          
          <input type="file" #fileInputExcel accept=".xlsx,.xls" (change)="importarRelatorioMensalExcel($event)" style="display: none;">
          <button mat-raised-button color="accent" type="button" (click)="fileInputExcel.click()">
            <mat-icon>file_upload</mat-icon>
            Importar (Excel)
          </button>

          <button mat-raised-button color="warn" (click)="exportarHistoricoCompletoJSON()" [disabled]="mesesDisponiveis.length === 0">
            <mat-icon>archive</mat-icon>
            Exportar Histórico Completo
          </button>
        </div>
      </div>
      
      <div *ngIf="mesSelecionado" class="mes-info">
        <p><strong>Mês atual:</strong> {{ formatarNomeMes(mesSelecionado) }}</p>
        <p><strong>Total de lançamentos:</strong> {{ lancamentos.length }}</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Formulário de Cadastro -->
  <mat-card class="mb-20 formulario-cadastro">
    <mat-card-header>
      <mat-card-title>
        <span *ngIf="!modoEdicao">Novo Lançamento</span>
        <span *ngIf="modoEdicao">Editar Lançamento</span>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="lancamentoForm" (ngSubmit)="adicionarLancamento()">
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Data</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="data" required>
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error *ngIf="lancamentoForm.get('data')?.hasError('required')">
              Data é obrigatória
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Descrição</mat-label>
            <input matInput formControlName="descricao" required>
            <mat-error *ngIf="lancamentoForm.get('descricao')?.hasError('required')">
              Descrição é obrigatória
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Valor</mat-label>
            <input matInput type="number" step="0.01" formControlName="valor" required>
            <span matPrefix>R$&nbsp;</span>
            <mat-error *ngIf="lancamentoForm.get('valor')?.hasError('required')">
              Valor é obrigatório
            </mat-error>
            <mat-error *ngIf="lancamentoForm.get('valor')?.hasError('min')">
              Valor deve ser maior que zero
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Tipo</mat-label>
            <mat-select formControlName="tipo" required>
              <mat-option value="GASTO">Gasto</mat-option>
              <mat-option value="RECEITA">Receita</mat-option>
            </mat-select>
            <mat-error *ngIf="lancamentoForm.get('tipo')?.hasError('required')">
              Tipo é obrigatório
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Categoria</mat-label>
            <mat-select formControlName="categoria" required>
              <mat-option *ngFor="let categoria of categoriasFiltradas" [value]="categoria.nome">
                {{ categoria.nome }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="lancamentoForm.get('categoria')?.hasError('required')">
              Categoria é obrigatória
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-buttons mt-20">
          <button mat-raised-button color="primary" type="submit">
            <mat-icon>{{ modoEdicao ? 'save' : 'add' }}</mat-icon>
            {{ modoEdicao ? 'Salvar Alterações' : 'Adicionar' }}
          </button>
          <button *ngIf="modoEdicao" mat-raised-button type="button" (click)="cancelarEdicao()" class="cancel-button">
            <mat-icon>close</mat-icon>
            Cancelar
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Cards de Totais -->
  <div class="totais-container">
    <mat-card class="total-card receita">
      <mat-card-content>
        <h2>Total de Receitas</h2>
        <p class="valor">{{ formatarValor(totalReceitas) }}</p>
      </mat-card-content>
    </mat-card>

    <mat-card class="total-card gasto">
      <mat-card-content>
        <h2>Total de Gastos</h2>
        <p class="valor">{{ formatarValor(totalGastos) }}</p>
      </mat-card-content>
    </mat-card>

    <mat-card class="total-card saldo" [ngClass]="{'saldo-positivo': saldoFinal >= 0, 'saldo-negativo': saldoFinal < 0}">
      <mat-card-content>
        <h2>Saldo Final</h2>
        <p class="valor">{{ formatarValor(saldoFinal) }}</p>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Cards de Status de Pagamento -->
  <div class="status-container">
    <mat-card class="status-card pago">
      <mat-card-content>
        <div class="status-header">
          <mat-icon class="status-icon">check_circle</mat-icon>
          <h2>Gastos Pagos</h2>
        </div>
        <p class="valor">{{ formatarValor(gastosPagos) }}</p>
        <div class="status-badge">
          <span>{{ totalGastos > 0 ? ((gastosPagos / totalGastos) * 100).toFixed(1) : '0.0' }}%</span>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="status-card pendente-dia15">
      <mat-card-content>
        <div class="status-header">
          <mat-icon class="status-icon">event</mat-icon>
          <h2>Gastos Pendentes (Dia 15)</h2>
        </div>
        <p class="subtitle">Vencem antes do dia 31</p>
        <p class="valor">{{ formatarValor(gastosPendentesDia15) }}</p>
        <div class="status-badge">
          <span>{{ totalGastos > 0 ? ((gastosPendentesDia15 / totalGastos) * 100).toFixed(1) : '0.0' }}%</span>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="status-card pendente-dia31">
      <mat-card-content>
        <div class="status-header">
          <mat-icon class="status-icon">event_available</mat-icon>
          <h2>Gastos Pendentes (Dia 31)</h2>
        </div>
        <p class="subtitle">Vencem no dia 31</p>
        <p class="valor">{{ formatarValor(gastosPendentesDia31) }}</p>
        <div class="status-badge">
          <span>{{ totalGastos > 0 ? ((gastosPendentesDia31 / totalGastos) * 100).toFixed(1) : '0.0' }}%</span>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="status-card recebido">
      <mat-card-content>
        <div class="status-header">
          <mat-icon class="status-icon">account_balance_wallet</mat-icon>
          <h2>Receitas Recebidas</h2>
        </div>
        <p class="valor">{{ formatarValor(receitasPagas) }}</p>
        <div class="status-badge">
          <span>{{ totalReceitas > 0 ? ((receitasPagas / totalReceitas) * 100).toFixed(1) : '0.0' }}%</span>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Botões de Exportação e Duplicação -->
  <div class="export-container mt-20">
    <button mat-raised-button color="accent" (click)="exportarExcel()" [disabled]="lancamentos.length === 0">
      <mat-icon>file_download</mat-icon>
      Exportar Mês para Excel
    </button>
    <button mat-raised-button color="primary" (click)="duplicarMesParaProximo()" [disabled]="lancamentos.length === 0">
      <mat-icon>content_copy</mat-icon>
      Duplicar Mês para Próximo Mês
    </button>
  </div>

  <!-- Tabelas de Lançamentos Separadas -->
  <div class="tabelas-container">
    <!-- Tabela de Receitas -->
    <mat-card class="tabela-card receitas-card">
      <mat-card-header class="card-header-receitas">
        <mat-card-title>
          <mat-icon class="header-icon">trending_up</mat-icon>
          Receitas
          <span class="badge-count">{{ dataSourceReceitas.data.length }}</span>
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="dataSourceReceitas" class="tabela-receitas">
          <!-- Coluna Data -->
          <ng-container matColumnDef="data">
            <th mat-header-cell *matHeaderCellDef>Data</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-data">
              <mat-icon class="cell-icon">calendar_today</mat-icon>
              {{ formatarDia(lancamento.data) }}
            </td>
          </ng-container>

          <!-- Coluna Descrição -->
          <ng-container matColumnDef="descricao">
            <th mat-header-cell *matHeaderCellDef>Descrição</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-descricao">
              <strong>{{ lancamento.descricao }}</strong>
            </td>
          </ng-container>

          <!-- Coluna Categoria -->
          <ng-container matColumnDef="categoria">
            <th mat-header-cell *matHeaderCellDef>Categoria</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-categoria">
              <span class="badge-categoria receita-badge">{{ lancamento.categoria }}</span>
            </td>
          </ng-container>

          <!-- Coluna Valor -->
          <ng-container matColumnDef="valor">
            <th mat-header-cell *matHeaderCellDef class="header-valor">Valor</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-valor receita-valor">
              {{ formatarValor(lancamento.valor) }}
            </td>
          </ng-container>

          <!-- Coluna Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef class="header-status">Status</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-status">
              <button 
                mat-mini-fab 
                [color]="lancamento.pago ? 'primary' : 'basic'"
                (click)="marcarComoPago(lancamento)"
                [matTooltip]="lancamento.pago ? 'Marcar como não pago' : 'Marcar como pago'"
                class="status-button">
                <mat-icon>{{ lancamento.pago ? 'check' : 'close' }}</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Coluna Ações -->
          <ng-container matColumnDef="acoes">
            <th mat-header-cell *matHeaderCellDef class="header-acoes">Ações</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-acoes">
              <button mat-icon-button color="primary" (click)="editarLancamento(lancamento)" matTooltip="Editar">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="accent" (click)="duplicarLancamento(lancamento)" matTooltip="Duplicar">
                <mat-icon>content_copy</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="excluirLancamento(lancamento)" matTooltip="Excluir">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns" class="header-row-receitas"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns" 
              class="row-receitas" 
              [ngClass]="{'vencido': estaVencido(row)}"></tr>
        </table>
        
        <!-- Mensagem quando não há receitas -->
        <div *ngIf="dataSourceReceitas.data.length === 0" class="no-data-message">
          <mat-icon>info</mat-icon>
          <p>Nenhuma receita cadastrada neste mês.</p>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Tabela de Gastos -->
    <mat-card class="tabela-card gastos-card">
      <mat-card-header class="card-header-gastos">
        <mat-card-title>
          <mat-icon class="header-icon">trending_down</mat-icon>
          Gastos
          <span class="badge-count">{{ dataSourceGastos.data.length }}</span>
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="dataSourceGastos" class="tabela-gastos">
          <!-- Coluna Data -->
          <ng-container matColumnDef="data">
            <th mat-header-cell *matHeaderCellDef>Data</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-data">
              <mat-icon class="cell-icon">calendar_today</mat-icon>
              {{ formatarDia(lancamento.data) }}
            </td>
          </ng-container>

          <!-- Coluna Descrição -->
          <ng-container matColumnDef="descricao">
            <th mat-header-cell *matHeaderCellDef>Descrição</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-descricao">
              <strong>{{ lancamento.descricao }}</strong>
            </td>
          </ng-container>

          <!-- Coluna Categoria -->
          <ng-container matColumnDef="categoria">
            <th mat-header-cell *matHeaderCellDef>Categoria</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-categoria">
              <span class="badge-categoria gasto-badge">{{ lancamento.categoria }}</span>
            </td>
          </ng-container>

          <!-- Coluna Valor -->
          <ng-container matColumnDef="valor">
            <th mat-header-cell *matHeaderCellDef class="header-valor">Valor</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-valor gasto-valor">
              {{ formatarValor(lancamento.valor) }}
            </td>
          </ng-container>

          <!-- Coluna Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef class="header-status">Status</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-status">
              <button 
                mat-mini-fab 
                [color]="lancamento.pago ? 'primary' : 'basic'"
                (click)="marcarComoPago(lancamento)"
                [matTooltip]="lancamento.pago ? 'Marcar como não pago' : 'Marcar como pago'"
                class="status-button">
                <mat-icon>{{ lancamento.pago ? 'check' : 'close' }}</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Coluna Ações -->
          <ng-container matColumnDef="acoes">
            <th mat-header-cell *matHeaderCellDef class="header-acoes">Ações</th>
            <td mat-cell *matCellDef="let lancamento" class="cell-acoes">
              <button mat-icon-button color="primary" (click)="editarLancamento(lancamento)" matTooltip="Editar">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="accent" (click)="duplicarLancamento(lancamento)" matTooltip="Duplicar">
                <mat-icon>content_copy</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="excluirLancamento(lancamento)" matTooltip="Excluir">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns" class="header-row-gastos"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns" 
              class="row-gastos" 
              [ngClass]="{'vencido': estaVencido(row)}"></tr>
        </table>
        
        <!-- Mensagem quando não há gastos -->
        <div *ngIf="dataSourceGastos.data.length === 0" class="no-data-message">
          <mat-icon>info</mat-icon>
          <p>Nenhum gasto cadastrado neste mês.</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

